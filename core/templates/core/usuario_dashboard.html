{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - SEMUJERES</title>
    <link rel="stylesheet" href="{% static 'core/css/usuario_dashboard.css' %}">
    <link rel="icon" href="{% static 'core/img/zaclogo-removebg-preview.png' %}" type="image/png">
    <script src="https://kit.fontawesome.com/1165876da6.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <div class="barra-superior">
        <div class="barra-izquierda">
            <img src="{% static 'core/img/zaclogo.jpeg' %}" alt="Zacatecas Logo" class="logo-barra">
            <a href="https://zacatecas.gob.mx" class="link-zacatecas" target="_blank">zacatecas.gob.mx</a>
        </div>

        <div class="barra-derecha">
            <a href="{% url 'cambiar_contrasena' %}" class="boton-salir">CAMBIAR CONTRASEÑA</a>
            <a href="{% url 'logout' %}" class="boton-salir">SALIR</a>
        </div>
    </div>

    <div class="banner-modelo">
        <img src="{% static 'core/img/modelo_igualdad.jpg' %}" alt="Modelo Igualdad" class="logo-modelo-banner">
    </div>

    <main class="contenido">
        <h2>SUBIR DOCUMENTOS</h2>

            <div class="barra-contenedor-dashboard">
                <p class="texto-porcentaje-dashboard">Documentos validados: {{ porcentaje_validados }}%</p>
                <div class="barra-progreso-dashboard">
                    <div class="barra-relleno-dashboard
                        {% if porcentaje_validados < 33 %}
                            rojo
                        {% elif porcentaje_validados < 66 %}
                            amarillo
                        {% else %}
                            verde
                        {% endif %}" style="width:{{ porcentaje_validados }}%"></div>
                </div>
            </div>


        <form method="post" enctype="multipart/form-data" id="form-subida">
            {% csrf_token %}
            <table class="tabla-documentos">
                <thead>
                    <tr>
                        <th>Documento</th>
                        <th>Fecha de Subida</th>
                        <th>Nombre</th>
                        <th>Observaciones</th>
                        <th>Estado</th>
                        <th colspan="2">Archivo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documentos %}
                    <tr>
                        <td style="position: relative;">
                            <span class="tooltip-ayuda" data-text="{{ doc.anexo.descripcion }}">? </span>
                            {{ doc.anexo.nombre }}
                        </td>
                        <td>
                            {% if doc.archivo %}
                                {{ doc.fecha_subida|date:"d-m-Y" }}
                            {% endif %}
                        </td>
                        <td>
                            {% if doc.archivo %}
                                {{ doc.archivo.name|cut:"documentos/"|cut:".pdf" }}
                            {% endif %}
                        </td>
                        <td>{{ doc.observaciones|default:"—" }}</td>
                        <td>{{ doc.get_estado_display }}</td>
                        
                        <td colspan="2">
                            {% if not doc.archivo or doc.estado == 'rechazado' %}
                                <div class="subida-contenedor">
                                    <label for="archivo_{{ doc.id }}" class="upload-icon">
                                        <img src="{% static 'core/img/arrow_upload.png' %}" alt="Subir archivo" width="24" height="24" />
                                    </label>
                                    <input type="file" id="archivo_{{ doc.id }}" name="documento_{{ doc.id }}" accept=".pdf" class="input-oculto">
                                    {% if doc.archivo and doc.estado == 'rechazado' %}
                                        <p class="texto-rechazado">Archivo rechazado. Vuelva a subir.</p>
                                    {% endif %}
                                </div>
                            {% else %}
                                <a href="{{ doc.archivo.url }}" target="_blank">
                                    <img src="{% static 'core/img/visibility.png' %}" alt="Ver archivo" width="24" height="24" />
                                </a>
                            {% endif %}
                        </td>

                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">No hay documentos disponibles.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if documentos %}
            <div class="boton-subida">
                <button type="button" onclick="validarYEnviar()">Subir Archivos Seleccionados</button>
            </div>
            {% endif %}
        </form>
    </main>

    <footer>
       
        <div class="footer-container">
            
            <div class="footer-col footer-logo-1">
                <img src="{% static 'core/img/logo_labsol.png' %}" alt="Logo Labsol">
            </div>

            <div class="footer-col footer-logo-2">
                <img src="{% static 'core/img/GPLv3_Logo.svg.png' %}" alt="Logo GPLv3">
            </div>

            <div class="footer-col footer-col-dir">
                <h3>Dirección</h3>
                <p>Circuito Cerro del Gato s/n<br>Ciudad Administrativa</p>
                <p>CP 98160, Zacatecas, Zac.</p>
            </div>

            <div class="footer-col">
                <h3>Equipo</h3>
                <ul>
                    <li>Alejandro Chávez Murillo</li>
                    <li>Jesús Alberto Rodríguez Valencia</li>
                    <li>Karla Guadalupe Rocha Quezada</li>
                </ul>
            </div>

            <div class="footer-col">
                <h3>Contacto</h3>
                <p><i class="fa-solid fa-phone"></i> 492 491 5000</p>
                <p><i class="fa-solid fa-envelope"></i> contacto@zacatecas.gob.mx</p>
                <div class="social-icons">
                    <a href="https://www.facebook.com/gobiernozac/" target="_blank"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="https://twitter.com/gobiernozac" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
                    <a href="https://www.instagram.com/gobiernozac/" target="_blank"><i class="fa-brands fa-instagram"></i></a>
                    <a href="https://www.youtube.com/user/gobiernozac" target="_blank"><i class="fa-brands fa-youtube"></i></a>
                </div>
            </div>
        </div>

    </footer>

{% if messages %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for message in messages %}
            Swal.fire({
                title: "{% if message.tags == 'success' %}¡Excelente!{% else %}Aviso{% endif %}",
                text: "{{ message }}",
                icon: "{% if message.tags == 'success' %}success{% else %}warning{% endif %}",
                confirmButtonText: 'Aceptar',
                confirmButtonColor: '#800040' // Color institucional Guinda
            });
        {% endfor %}
    });
</script>
{% endif %}

<script>
    // Función para validar si hay archivos antes de enviar y mostrar "Cargando"
    function validarYEnviar() {
        const fileInputs = document.querySelectorAll('.input-oculto');
        let archivoSeleccionado = false;

        // Verificar si al menos un input tiene archivo
        fileInputs.forEach(input => {
            if (input.files.length > 0) {
                archivoSeleccionado = true;
            }
        });

        if (archivoSeleccionado) {
            // Mostrar mensaje de carga mientras el servidor procesa
            let timerInterval;
            Swal.fire({
                title: 'Subiendo documentos...',
                html: 'Por favor espere mientras guardamos su información.',
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Enviar el formulario
            document.getElementById('form-subida').submit();
        } else {
            // Alerta si no seleccionó nada
            Swal.fire({
                title: 'Sin archivos',
                text: 'Por favor selecciona al menos un documento para subir.',
                icon: 'warning',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#800040'
            });
        }
    }

    // Lógica para cambiar color del icono cuando se selecciona archivo
    document.addEventListener('DOMContentLoaded', () => {
        const fileInputs = document.querySelectorAll('.input-oculto');

        fileInputs.forEach(input => {
            input.addEventListener('change', () => {
                const label = document.querySelector(`label[for="${input.id}"]`);

                if (input.files.length > 0) {
                    // Cambia color a verde si hay archivo seleccionado
                    label.style.backgroundColor = '#4CAF50'; 
                    label.style.borderColor = '#4CAF50';
                    // Opcional: Cambiar el icono o añadir borde visual
                } else {
                    // Vuelve al color original si no hay archivo
                    label.style.backgroundColor = '#f0f0f0';
                    label.style.borderColor = '#ccc';
                }
            });
        });
    });
</script>

</body>
</html>